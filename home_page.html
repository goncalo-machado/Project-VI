<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <script type="text/javascript" src="http://d3js.org/d3.v7.js"></script>

    <!-- Title tha appears in the searcher tab  -->
    <title>DETI Courses Data Visualisation</title>

    <!-- CSS -->
    <style>

        /* Config of entery site */
        *{
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        html, body {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }

        /* For the Main Title */
        h1{
            font-family: Arial, sans-serif;
            color: black; /* Cores: https://www.w3schools.com/cssref/css_colors.php */
            font-size: 50px;
            text-align: center;
            background-image: linear-gradient(90deg, white, lightblue, white);
            background-size: 100% 3px;
            background-position: 0 100%;
            padding: 20px 0;
        }

        /* To the H2 Title */
        h2{
            color: black;
            font-size: 25px;
            padding-left: 5px;
        }

        /* Confi the H2 and the dropList*/
        .H2_dropList {
            display: flex;
            align-items: center;
        }

        /* Configuration of the droplist */
       .droplist_year{
            font-family: Arial, sans-serif;
            color: black;
            font-size: 25px;
            border: none;
            margin-left: 5px;
        }

        /* Config the Buttons*/
        .buttons_DETI_courses {
            display: flex;
            flex-direction: linear;
            align-items: center;
        }

        /* Style of the buttons */
        .buttons_DETI{
            background-color: lightblue;
            color: black;
            font-size: 20px;
            margin-left: 5px;
            border-radius: 5px;
            border: none;
        }

        /* Config do d3 */
        .div_d3 {
            display: flex;
            justify-content: center;

        }
        /* To users noticed that bars are clickable */
        rect:hover {
            cursor: pointer;
            fill: Navy;
        }

    </style>

</head>

<body>

    <!-- Main Title -->
    <h1> DETI Courses Data Visualisation </h1>

    <!-- Define the Buttons for each DETI course -->
    <div class="buttons_DETI_courses">
        <button class="buttons_DETI" id="button_Aer_Eng"> Aerospace Engineering</button>
        <button class="buttons_DETI" id="button_Bio_Eng"> Biomedical Engineering</button>
        <button class="buttons_DETI" id="button_CS_Eng"> Computer Science and Engineering</button>
        <button class="buttons_DETI" id="button_Comp_Eng"> Computational Engineering</button>
        <button class="buttons_DETI" id="button_CompEng_Inf"> Computer Engineering and Informatics</button>
        <button class="buttons_DETI" id="button_EleComp_Eng"> Electrical and Computer Engineering</button>
        <button class="buttons_DETI" id="button_IndAut_Eng"> Industrial Automation Engineering</button>
    </div>

    <!-- Container for H2 title and the DropList with curriculam years -->
    <div class="H2_dropList">
        <!-- Title -->
        <h2> Curricular Year </h2>

        <!-- Define the DropList with curricular years -->
        <select id="droplist" class="droplist_year" onchange="year_selection()">
            <option value="2021"> 2021/22 </option>
            <option value="2022"> 2022/23 </option>
            <option value="2023"> 2023/24 </option>
        </select>
    </div>

    <!-- Other possibilitie for graphs: https://www.chartjs.org/ -->
    <!-- D3 Section - Front Page -->
    <div class="div_d3"> </div>

    <!-- Script that has all the charts -->
    <script type="text/javascript">

        // Set the dimensions and margins of the graph
        const margin = {top: 50, right: 50, bottom: 120, left: 50}, // Space for axis legends
                                width = 800 - margin.left - margin.right,
                                height = 800 - margin.top - margin.bottom;

        // Create the SVG (the space) to put the Bar Chart of the number of applicants by DETI course
        const bar_chart_SVG = d3.select(".div_d3")
                                .append("svg")
                                    .attr("width", width + margin.left + margin.right)
                                    .attr("height", height + margin.top + margin.bottom)
                                    .style("background", "#DCDCDC") // Just to see the space
                                .append("g") // Section to plot the axis legends
                                    .attr("transform", `translate(${margin.top})`);

        // Create the SVG (the space) to put the Circle Chart of the number of applicants by DETI course
        const circle_chart_SVG = d3.select(".div_d3")
                        .append("svg")
                            .attr("width", width + margin.left + margin.right)
                            .attr("height", height + margin.top + margin.bottom)
                            .style("background", "#808080"); // Just to see the space
        
        // Get the selected item in the droplist
        year_selection()
        // Evething needs to change when the value in the droplist changes
        function year_selection(){
            // Reset the SVG
            bar_chart_SVG.selectAll("*").remove();
            // Define the Dataset with all data
            d3.csv("https://raw.githubusercontent.com/goncalo-machado/Project-VI/main/Dataset_Applicants_2021_2023.csv?token=GHSAT0AAAAAACJ32OOFC7YF6MSVXECN6KJMZKI52DQ").then(function(total_data) {

                // Data set with Last Placed Candidates Grades
                d3.csv("https://raw.githubusercontent.com/goncalo-machado/Project-VI/main/Dataset_DETI_Courses_2021_2023.csv?token=GHSAT0AAAAAACJ32OOEUYT2WTOYHLZXJVHYZKJAULQ").then(function(data_last_grade) {

                    /* ---------- CODE FOR THE BAR CHART ---------- */

                    // Condition that checks which droplist item is selected
                    var droplist_items = document.getElementById("droplist"); // Select the droplist
                    var droplist_item_selected = droplist_items.options[droplist_items.selectedIndex].value; // Get the item
                    /* CHECK WHICH DROPLIST ITEM IS SELECTED */
                    console.log("Selected year: " + droplist_item_selected);
                    /* ------------------------------------- */

                    // Filter the data needed for X, that is, DETI courses
                    const x_axis_filter = data_last_grade.filter(d => d['University Code'] === '0300' && d.Year === droplist_item_selected);
                    // Get the X information, that is, DETI courses to X axis
                    const x = d3.scaleBand()
                                .domain(x_axis_filter.map(d => d['Course Name']))
                                .range([ 0, width ]);
                    // Plot the X information in the axis
                    bar_chart_SVG.append("g")
                                    .attr("transform", `translate(0, ${height})`)
                                    .call(d3.axisBottom(x))
                                .selectAll("text")
                                    .attr("transform", "translate(-10,0)rotate(-45)")
                                    .style("text-anchor", "end");

                    // Filter the data needed for Y, that is, number of applicants for each DETI course
                    const y_axis_filter = total_data.filter(d => d['University Code'] === '0300' && d.Year === droplist_item_selected);

                    // Creat a new dataset to store the number of applicants for each DETI course
                    n_applicants_count = {};

                    // For each course, count the number of applicants
                    y_axis_filter.forEach(d => {
                        // Define the curse code
                        const course_code = d["Course Code"];
                        // If the coourse code was alredy detected, increment
                        if(n_applicants_count[course_code]){
                            n_applicants_count[course_code] += 1; // Count one student
                        }
                        else{
                            n_applicants_count[course_code] = 1; // Count the first apperance
                        }
                    });

                    // Make an array that can be used to make the bars
                    const dataset_n_applicants_count = Object.keys(n_applicants_count).map(courseCode => {
                        return { "Course Code": courseCode, "Count": n_applicants_count[courseCode] };
                    });
                    // Remove the first element from the array, that is, the one that starts with a number and put it in last
                    const firstElement = dataset_n_applicants_count.shift();
                    dataset_n_applicants_count.push(firstElement);
                    /* TO VERIFY IF THE COUNTING IS WORKING WELL */
                    console.log("Course applicants counting: ")
                    console.log(dataset_n_applicants_count);
                    /* ----------------------------------------- */

                    // Get the Y information and store it in Y
                    const y = d3.scaleLinear()
                        .domain([0, d3.max(dataset_n_applicants_count, d => d.Count) + margin.bottom])
                        .range([height, 0]);
                    /* CHECK Y VALUES */
                    //bar_chart_SVG.append("g")
                    //    .call(d3.axisLeft(y));
                    /* -------------- */

                    // Plot the Bars
                    const bars = bar_chart_SVG.selectAll("mybar")
                        .data(dataset_n_applicants_count)
                        .enter()
                        .append("rect")
                            .attr("x", d => x(d["Course Code"]))
                            .attr("y", d => y(d.Count))
                            .attr("width", x.bandwidth() / 2)
                            .attr("height", function(d) { return height - y(d.Count); })
                            .attr("fill", "steelblue")
                        // Append text on top of each bar with the count value
                        .each(function(d, i) {
                            bar_chart_SVG.append("text")
                                .attr("x", function() {
                                    return i * (width / dataset_n_applicants_count.length) + ((width / dataset_n_applicants_count.length) / 2);
                                })
                                .attr("y", y(d.Count) - 10)
                                .attr("text-anchor", "middle")
                                .style("font-size", "20px")
                                .text(d.Count)
                                // Start of the animation of the text on top of each bar
                                .style("opacity", 0)
                                .transition()
                                .duration(2000)
                                .style("opacity", 1)
                                .delay(function() { return i * 100; });
                            });

                    // Plot the title
                    bar_chart_SVG.append("text")
                        .attr("x", width / 2)
                        .attr("y", margin.top)
                        .attr("text-anchor", "middle")
                        .style("font-size", "25px")
                        .text("Number of Applicants of all DETI Courses");

                    // Calculate DETI total of applicants
                    const total_DETI_applicants = dataset_n_applicants_count.reduce((sum, entry) => sum + entry.Count, 0);
                    // Add the total DETI applicants
                    bar_chart_SVG.append("text")
                        .attr("x", width / 2)
                        .attr("y", margin.top + 30)
                        .attr("text-anchor", "middle")
                        .style("font-size", "20px")
                        .text("Total Applicants: " + total_DETI_applicants);

                    // Animation (For some reason, only when i put the animation, all the bars were ploted. Apperently they were overlapped.)
                    bar_chart_SVG.selectAll("rect")
                        .transition()
                        .duration(1000)
                        .attr("x", function(d, i) {
                            return i * (width / dataset_n_applicants_count.length) + ((width / dataset_n_applicants_count.length) / 4);
                        })
                        .delay(function(d,i){ return(i*100) });

                    /* -------------------------------------------- */

                    /* ---------- CODE FOR THE CIRCLE CHART ---------- */
                    
                    // Plot the title
                    circle_chart_SVG.append("text")
                        .attr("x", (width + margin.left + margin.right) / 2)
                        .attr("y", margin.top)
                        .attr("text-anchor", "middle")
                        .style("font-size", "25px")
                        .text("Application Choice Option");

                    // Function to reset the chart every time an new event occours
                    function clearCircleChart() {
                        circle_chart_SVG.selectAll("circle").remove();
                        circle_chart_SVG.selectAll("text").remove();
                    }

                    // Variable to keep track of the selected bar
                    let selectedBar = null;
                    // Make each bar clickable to select a DETI course
                    bars.on("click", function(d, i) {

                        // Check if the clicked bar is already selected
                        const isSelected = d3.select(this).attr("fill") === "Navy";
                        // De-select all bars
                        bars.attr("fill", "steelblue");
                        // Reset the state if a different bar is clicked
                        if (selectedBar !== this) {
                            d3.select(selectedBar).attr("fill", "steelblue");
                            selectedBar = null;
                        }
                        // Get the coure selected
                        const selec_course = i["Course Code"];
                        // If the clicked bar was not selected, select it
                        if (!isSelected) {

                            // Clear the existing circles and text
                            clearCircleChart();

                            // Plot the title
                            circle_chart_SVG.append("text")
                                .attr("x", (width + margin.left + margin.right) / 2)
                                .attr("y", margin.top)
                                .attr("text-anchor", "middle")
                                .style("font-size", "25px")
                                .text("Application Choice Option");

                            // Select the Bar
                            d3.select(this).attr("fill", "Navy");
                            selectedBar = this;

                            // Get the dataset of the select course for the selected year
                            const course_filter = total_data.filter(d => d['University Code'] === '0300' && d.Year === droplist_item_selected && d['Course Code'] === selec_course);
                            // Creat a new dataset to store the option number
                            n_option_number = {};
                            // For each applicant, count the number of times that one option appears
                            course_filter.forEach(d => {
                                // Define the curse code
                                const option_number = d["Option Number"];
                                // If the coourse code was alredy detected, increment
                                if(n_option_number[option_number]){
                                    n_option_number[option_number] += 1; // Count one student
                                }
                                else{
                                    n_option_number[option_number] = 1; // Count the first apperance
                                }
                             });
                            /* TO VERIFY IF THE COUNTING IS WORKING WELL */
                            const dataset_n_option_number = Object.keys(n_option_number).map(OptionNumber => {
                                return { "Option Number": OptionNumber, "Count": (n_option_number[OptionNumber] / i.Count) * 100 };
                            });
                            console.log("Course Option Number(%): ")
                            console.log(dataset_n_option_number);
                            /* ----------------------------------------- */

                            // Define the circle in the circular packing
                            var circles = circle_chart_SVG.append("g")
                                .selectAll("circle")
                                .data(dataset_n_option_number)
                                .enter()
                                .append("circle")
                                    .attr("cx", (width + margin.left + margin.right) / 2) 
                                    .attr("cy", (height + margin.top + margin.bottom) / 2)
                                    .style("fill", "steelblue")
                                    .style("fill-opacity", 0.3)
                                    .attr("stroke", "Navy")
                                    .style("stroke-width", 4)
                                    .attr("r", function(d) {
                                        // Attributes a radius to a circle based on its value, that is, the radius is related to the value
                                        return d3.scaleLinear()
                                                    .domain([d3.min(dataset_n_option_number, function(d) { return d.Count; }),
                                                            d3.max(dataset_n_option_number, function(d) { return d.Count; })])
                                                    .range([50, 100])(d.Count);
                                    });
                                                  
                            // This will simulate the animation of the circles
                            var simulation = d3.forceSimulation()
                                .force("center", d3.forceCenter().x((width + margin.left + margin.right) / 2).y((height + margin.top + margin.bottom) / 2))
                                .force("charge", d3.forceManyBody().strength(0.5))
                                .force("collide", d3.forceCollide().strength(0.01).radius(100).iterations(1))
                            // Apply the simulation when each bar is clicked
                            simulation.nodes(dataset_n_option_number)
                                .on("tick", function(d){
                                    // Simulation of the circles
                                    circles.attr("cx", function(d){ return d.x; })
                                            .attr("cy", function(d){ return d.y; });
                                    // Simulation of the text of each circle
                                    legend.attr("x", function(d){ return d.x; })
                                            .attr("y", function(d){ return d.y; });
                                });
                            
                            // This will calculate a random position to the circles
                            circles.each(function(d) {
                                // Calculate the maximum x and y within the SVG boundaries
                                var maxX = width - 200;
                                var maxY = height - 200;
                                // Generate random x and y coordinates within the SVG boundaries
                                d.x = Math.floor(Math.random() * maxX) + 50;
                                d.y = Math.floor(Math.random() * maxY) + 50;
                            });
                            // This will create the text to put on each circle
                            var legend = circle_chart_SVG.append("g")
                                .selectAll("text")
                                .data(dataset_n_option_number)
                                .enter()
                                .append("text")
                                .text(function (d) {
                                    var percnt_form = parseFloat(d.Count).toFixed(2);
                                    return d["Option Number"] + "Âª: " + percnt_form + "%";
                                })
                                .attr("text-anchor", "middle")
                                .attr("alignment-baseline", "middle")
                                .attr("x", function (d) { return d.x; })
                                .attr("y", function (d) { return d.y; })
                                .style("fill", "black");
                        
                        }
                        else{
                            // Clear the existing circles and text when nothing is selected
                            clearCircleChart();
                            // Plot the title
                            circle_chart_SVG.append("text")
                                .attr("x", (width + margin.left + margin.right) / 2)
                                .attr("y", margin.top)
                                .attr("text-anchor", "middle")
                                .style("font-size", "25px")
                                .text("Application Choice Option");
                        }
            
                    }); // End of the bar click action
                    /* -------------------------------------------- */

                }) // End of data_last_grade dataset

            }) // End of tota_dataset dataset

        } // End of the year_selection function

    </script>

</body>

</html>